{% extends "online_health_consultation/Base.html" %}
{% load static %}

{% block title %}Register - {{ block.super }}{% endblock %}

{% block extrahead %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    function toggleDoctorFields() {
        const userType = document.querySelector('input[name="user_type"]:checked').value;
        const doctorFields = document.getElementById('doctorFields');
        if (doctorFields) {
            doctorFields.style.display = userType === 'doctor' ? 'block' : 'none';
            const inputs = doctorFields.querySelectorAll('input');
            inputs.forEach(input => {
                input.required = userType === 'doctor';
            });
        }
    }

    // Add event listeners to radio buttons
    const userTypeInputs = document.querySelectorAll('input[name="user_type"]');
    userTypeInputs.forEach(input => {
        input.addEventListener('change', toggleDoctorFields);
    });

    // Initial toggle based on default selection
    setTimeout(toggleDoctorFields, 100);
});
</script>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-body p-5">
                    <!-- Registration Header -->
                    <div class="text-center mb-4">
                        <h2 class="fw-bold text-success">
                            <i class="fas fa-user-plus me-2"></i>Create Account
                        </h2>
                        <p class="text-muted">Join our healthcare platform for personalized medical consultation</p>
                    </div>

                    <!-- Registration Form -->
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- User Type Selection -->
                        <div class="mb-4">
                            <label class="form-label d-block">Register as:</label>
                            <div class="btn-group w-100" role="group">
                                {% for value, text in form.user_type.field.choices %}
                                <input type="radio" class="btn-check" name="{{ form.user_type.name }}"
                                       id="{{ value }}" value="{{ value }}" 
                                       {% if forloop.first %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="{{ value }}">
                                    <i class="fas {% if value == 'patient' %}fa-user{% else %}fa-user-md{% endif %} me-2"></i>
                                    {{ text }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Basic Info -->
                        <div class="row">
                            <!-- First Name -->
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" 
                                           id="{{ form.first_name.id_for_label }}" 
                                           name="first_name" 
                                           placeholder="First Name"
                                           value="{{ form.first_name.value|default:'' }}"
                                           required>
                                    <label for="{{ form.first_name.id_for_label }}">First Name</label>
                                    {% if form.first_name.errors %}
                                        <div class="invalid-feedback">{{ form.first_name.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Last Name -->
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" 
                                           id="{{ form.last_name.id_for_label }}" 
                                           name="last_name" 
                                           placeholder="Last Name"
                                           required>
                                    <label for="{{ form.last_name.id_for_label }}">Last Name</label>
                                    {% if form.last_name.errors %}
                                        <div class="invalid-feedback">{{ form.last_name.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Username -->
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control {% if form.username.errors %}is-invalid{% endif %}" 
                                       id="{{ form.username.id_for_label }}" 
                                       name="username" 
                                       placeholder="Username"
                                       required>
                                <label for="{{ form.username.id_for_label }}">Username</label>
                                {% if form.username.errors %}
                                    <div class="invalid-feedback">{{ form.username.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="email" class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                                       id="{{ form.email.id_for_label }}" 
                                       name="email" 
                                       placeholder="Email Address"
                                       required>
                                <label for="{{ form.email.id_for_label }}">Email Address</label>
                                {% if form.email.errors %}
                                    <div class="invalid-feedback">{{ form.email.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Date of Birth -->
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="date" class="form-control {% if form.date_of_birth.errors %}is-invalid{% endif %}" 
                                       id="{{ form.date_of_birth.id_for_label }}" 
                                       name="date_of_birth" 
                                       required>
                                <label for="{{ form.date_of_birth.id_for_label }}">Date of Birth</label>
                                {% if form.date_of_birth.errors %}
                                    <div class="invalid-feedback">{{ form.date_of_birth.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Phone Number -->
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="tel" class="form-control {% if form.phone_number.errors %}is-invalid{% endif %}" 
                                       id="{{ form.phone_number.id_for_label }}" 
                                       name="phone_number" 
                                       placeholder="Phone Number">
                                <label for="{{ form.phone_number.id_for_label }}">Phone Number (Optional)</label>
                                {% if form.phone_number.errors %}
                                    <div class="invalid-feedback">{{ form.phone_number.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Blood Group -->
                        <div class="mb-3">
                            <div class="form-floating">
                                <select class="form-select {% if form.blood_group.errors %}is-invalid{% endif %}" 
                                        id="{{ form.blood_group.id_for_label }}" 
                                        name="blood_group">
                                    {% for value, text in form.blood_group.field.choices %}
                                    <option value="{{ value }}" {% if form.blood_group.value == value %}selected{% endif %}>
                                        {{ text }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <label for="{{ form.blood_group.id_for_label }}">Blood Group (Optional)</label>
                                {% if form.blood_group.errors %}
                                    <div class="invalid-feedback">{{ form.blood_group.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Emergency Contact -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">Emergency Contact Details</h6>
                                
                                <!-- Emergency Contact Name -->
                                <div class="mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control {% if form.emergency_contact_name.errors %}is-invalid{% endif %}" 
                                               id="{{ form.emergency_contact_name.id_for_label }}" 
                                               name="emergency_contact_name" 
                                               placeholder="Emergency Contact Name"
                                               required>
                                        <label for="{{ form.emergency_contact_name.id_for_label }}">Emergency Contact Name</label>
                                        {% if form.emergency_contact_name.errors %}
                                            <div class="invalid-feedback">{{ form.emergency_contact_name.errors|join:", " }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Emergency Contact Phone -->
                                <div class="mb-3">
                                    <div class="form-floating">
                                        <input type="tel" class="form-control {% if form.emergency_contact_phone.errors %}is-invalid{% endif %}" 
                                               id="{{ form.emergency_contact_phone.id_for_label }}" 
                                               name="emergency_contact_phone" 
                                               placeholder="Emergency Contact Phone"
                                               required>
                                        <label for="{{ form.emergency_contact_phone.id_for_label }}">Emergency Contact Phone</label>
                                        {% if form.emergency_contact_phone.errors %}
                                            <div class="invalid-feedback">{{ form.emergency_contact_phone.errors|join:", " }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Password -->
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="password" class="form-control {% if form.password1.errors %}is-invalid{% endif %}" 
                                       id="{{ form.password1.id_for_label }}" 
                                       name="password1" 
                                       placeholder="Password"
                                       required>
                                <label for="{{ form.password1.id_for_label }}">Password</label>
                                {% if form.password1.errors %}
                                    <div class="invalid-feedback">{{ form.password1.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Confirm Password -->
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="password" class="form-control {% if form.password2.errors %}is-invalid{% endif %}" 
                                       id="{{ form.password2.id_for_label }}" 
                                       name="password2" 
                                       placeholder="Confirm Password"
                                       required>
                                <label for="{{ form.password2.id_for_label }}">Confirm Password</label>
                                {% if form.password2.errors %}
                                    <div class="invalid-feedback">{{ form.password2.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Doctor Specific Fields -->
                        <div id="doctorFields" class="doctor-fields">
                            <!-- Specialization -->
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control" 
                                           id="{{ form.specialization.id_for_label }}" 
                                           name="specialization" 
                                           placeholder="Specialization"
                                           value="{{ form.specialization.value|default:'' }}">
                                    <label for="{{ form.specialization.id_for_label }}">Specialization</label>
                                </div>
                            </div>

                            <!-- License Number -->
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control" 
                                           id="{{ form.license_number.id_for_label }}" 
                                           name="license_number" 
                                           placeholder="License Number"
                                           value="{{ form.license_number.value|default:'' }}">
                                    <label for="{{ form.license_number.id_for_label }}">License Number</label>
                                </div>
                            </div>

                            <!-- Experience Years -->
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="number" class="form-control" 
                                           id="{{ form.experience_years.id_for_label }}" 
                                           name="experience_years" 
                                           placeholder="Years of Experience"
                                           value="{{ form.experience_years.value|default:'' }}">
                                    <label for="{{ form.experience_years.id_for_label }}">Years of Experience</label>
                                </div>
                            </div>

                            <!-- Consultation Fee -->
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="number" step="0.01" class="form-control" 
                                           id="{{ form.consultation_fee.id_for_label }}" 
                                           name="consultation_fee" 
                                           placeholder="Consultation Fee"
                                           value="{{ form.consultation_fee.value|default:'' }}">
                                    <label for="{{ form.consultation_fee.id_for_label }}">Consultation Fee</label>
                                </div>
                            </div>
                        </div>

                        <style>
                            .doctor-fields {
                                background-color: #f8f9fa;
                                padding: 20px;
                                border-radius: 10px;
                                margin-bottom: 20px;
                                border: 1px solid #e9ecef;
                            }
                            .doctor-fields .form-control:invalid {
                                border-color: #dee2e6;
                                box-shadow: none;
                            }
                            .doctor-fields .form-floating > .form-control:focus,
                            .doctor-fields .form-floating > .form-control:not(:placeholder-shown) {
                                border-color: #198754;
                            }
                        </style>

                        <!-- Terms and Conditions -->
                        <div class="mb-4 form-check">
                            <input type="checkbox" class="form-check-input" id="terms" required>
                            <label class="form-check-label" for="terms">
                                I agree to the <a href="#" class="text-success">Terms of Service</a> and 
                                <a href="#" class="text-success">Privacy Policy</a>
                            </label>
                            <div class="invalid-feedback">
                                You must agree to the terms and conditions.
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success py-2">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </div>
                    </form>

                    <!-- Optional Divider -->
                    <div class="text-center my-4">
                        <div class="position-relative">
                            <hr>
                            <span class="position-absolute top-50 start-50 translate-middle bg-white px-2 text-muted small">OR</span>
                        </div>
                        <div class="d-flex justify-content-center gap-3 mt-3">
                            <a href="#" class="btn social-icon" title="Register with Google">
                                <i class="fa-brands fa-google" style="color: #206fac;"></i>
                            </a>
                            <a href="#" class="btn social-icon" title="Register with Facebook">
                                <i class="fa-brands fa-facebook" style="color: #114896;"></i>
                            </a>
                            <a href="#" class="btn social-icon" title="Register with Apple">
                                <i class="fa-brands fa-apple" style="color: #24bfc2;"></i>
                            </a>
                        </div>
                    </div>

                                        <style>
                        .social-icon {
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            padding: 0;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s ease;
                        }
                        .social-icon:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        }
                        .social-icon i {
                            font-size: 18px;
                            line-height: 1;
                            width: auto;
                            height: auto;
                        }
                        /* Form floating styles */
                        .form-floating > .form-control:focus,
                        .form-floating > .form-control:not(:placeholder-shown) {
                            padding-top: 1.625rem;
                            padding-bottom: 0.625rem;
                        }
                        .form-floating > .form-control:focus ~ label,
                        .form-floating > .form-control:not(:placeholder-shown) ~ label {
                            transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
                            color: #198754;
                        }
                        .form-floating > label {
                            padding: 1rem 0.75rem;
                            transition: all 0.2s ease-in-out;
                        }
                        .form-control:focus {
                            border-color: #198754;
                            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
                        }
                        /* Social icon colors */
                        .btn-outline-danger i {
                            color: #dc3545;
                        }
                        .btn-outline-primary i {
                            color: #0d6efd;
                        }
                        .btn-outline-dark i {
                            color: #212529;
                        }
                    </style>

                    <!-- Login Link -->
                    <div class="text-center mt-4">
                        <p class="mb-0">Already have an account? <a href="{% url 'login' %}" class="text-success fw-bold">Login</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Bootstrap form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', function (event) {
            const userType = document.querySelector('input[name="user_type"]:checked').value;
            const doctorFields = document.getElementById('doctorFields');
            
            if (userType === 'doctor') {
                // Make doctor fields required when doctor type is selected
                const doctorInputs = doctorFields.querySelectorAll('input');
                let isValid = true;
                
                doctorInputs.forEach(input => {
                    input.required = true;
                    if (!input.value.trim()) {
                        isValid = false;
                        // Add subtle indication without error styling
                        input.style.borderColor = '#dee2e6';
                    }
                });
                
                if (!isValid) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            }

            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
        }, false);
    });

    // Handle doctor fields visibility
    const userTypeInputs = document.querySelectorAll('input[name="user_type"]');
    const doctorFields = document.getElementById('doctorFields');
    
    function toggleDoctorFields() {
        const selectedType = document.querySelector('input[name="user_type"]:checked').value;
        doctorFields.style.display = selectedType === 'doctor' ? 'block' : 'none';
        
        // Toggle required attribute on doctor fields
        const doctorInputs = doctorFields.querySelectorAll('input');
        doctorInputs.forEach(input => {
            input.required = selectedType === 'doctor';
        });
    }

    userTypeInputs.forEach(input => {
        input.addEventListener('change', toggleDoctorFields);
    });

    // Initial toggle based on default selection
    toggleDoctorFields();

    // Password strength indicator
    const password = document.getElementById('id_password1');
    const strengthMeter = document.createElement('div');
    strengthMeter.className = 'progress mt-2';
    strengthMeter.style.height = '5px';
    
    if (password) {
        password.parentNode.appendChild(strengthMeter);
        
        password.addEventListener('input', function() {
            const strength = calculatePasswordStrength(this.value);
            updateStrengthMeter(strength);
        });
    }

    function calculatePasswordStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]/)) strength += 25;
        if (password.match(/[A-Z]/)) strength += 25;
        if (password.match(/[0-9]/)) strength += 25;
        return strength;
    }

    function updateStrengthMeter(strength) {
        let color = 'danger';
        if (strength > 75) color = 'success';
        else if (strength > 50) color = 'info';
        else if (strength > 25) color = 'warning';

        strengthMeter.innerHTML = `
            <div class="progress-bar bg-${color}" 
                 role="progressbar" 
                 style="width: ${strength}%" 
                 aria-valuenow="${strength}" 
                 aria-valuemin="0" 
                 aria-valuemax="100"></div>
        `;
    }
});
</script>
{% endblock %}
