{% extends "online_health_consultation/Base.html" %}
{% load crispy_forms_tags %}

{% block title %}Medical Records - Online Health Consultation{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Medical Records</h2>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadRecordModal">
            <i class="fas fa-upload me-2"></i>Upload New Record
        </button>
    </div>

    <!-- Records Filter -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Record Type</label>
                    <select name="record_type" class="form-select">
                        <option value="">All Types</option>
                        <option value="Lab Report">Lab Report</option>
                        <option value="X-Ray">X-Ray</option>
                        <option value="Prescription">Prescription</option>
                        <option value="Vaccination">Vaccination Record</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date From</label>
                    <input type="date" name="date_from" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date To</label>
                    <input type="date" name="date_to" class="form-control">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-outline-success">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Records List -->
    {% if records %}
    <div class="row">
        {% for record in records %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">{{ record.title }}</h5>
                    <p class="card-text">
                        <i class="far fa-calendar me-2"></i>{{ record.date|date:"F d, Y" }}<br>
                        <i class="fas fa-file-medical me-2"></i>{{ record.record_type }}<br>
                        {% if record.notes %}
                        <i class="fas fa-notes-medical me-2"></i>{{ record.notes|truncatechars:100 }}
                        {% endif %}
                    </p>
                    <div class="mt-3">
                        <a href="{{ record.file.url }}" class="btn btn-sm btn-outline-success me-2" target="_blank">
                            <i class="fas fa-eye me-1"></i>View
                        </a>
                        <a href="{{ record.file.url }}" class="btn btn-sm btn-outline-primary me-2" download>
                            <i class="fas fa-download me-1"></i>Download
                        </a>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord({{ record.id }})">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-file-medical fa-4x text-muted mb-3"></i>
        <h4>No Medical Records Found</h4>
        <p class="text-muted">Upload your medical records to keep them organized and accessible.</p>
        <button class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#uploadRecordModal">
            Upload Your First Record
        </button>
    </div>
    {% endif %}
</div>

<!-- Upload Record Modal -->
<div class="modal fade" id="uploadRecordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Medical Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" action="{% url 'upload_record' %}">
                    {% csrf_token %}
                    {{ upload_form|crispy }}
                    <button type="submit" class="btn btn-success mt-3">Upload Record</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function deleteRecord(recordId) {
    if (confirm('Are you sure you want to delete this record? This action cannot be undone.')) {
        fetch(`/records/delete/${recordId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}
</script>

<style>
.card {
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-5px);
}
</style>
{% endblock %}
